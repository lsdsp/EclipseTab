import React, { useState, useRef, useEffect } from 'react';
import { Space } from '../../types';
import { Modal } from './Modal';
import { useLanguage } from '../../context/LanguageContext';
import {
    buildSpaceImportPreview,
    formatSpaceImportPreviewMessage,
    buildSpaceExportData,
    decodeSpaceShareCode,
    encodeSpaceShareCode,
    exportSpaceToFile,
    exportAllSpacesToFile,
    ImportFileResult,
    parseSpaceImportSelectionInput,
    parseAndValidateImportFile,
    pickMultiSpaceImportData,
    SpaceExportData,
    MultiSpaceExportData,
} from '../../utils/spaceExportImport';
import plusIcon from '../../assets/icons/plus.svg';
import writeIcon from '../../assets/icons/write.svg';
import trashIcon from '../../assets/icons/trash.svg';
import pinIcon from '../../assets/icons/pin.svg';
import importIcon from '../../assets/icons/import.svg';
import exportIcon from '../../assets/icons/export.svg';
import editIcon from '../../assets/icons/edit.svg';
import styles from './SpaceManageMenu.module.css';

interface SpaceManageMenuProps {
    /** 是否显示 */
    isOpen: boolean;

    /** 锚点位置 (Navigator 的 DOMRect) */
    anchorRect: DOMRect | null;

    /** 当前空间 */
    currentSpace: Space;

    /** 所有空间 (用于导出所有) */
    allSpaces: Space[];

    /** 是否只剩一个空间 (禁用删除) */
    isLastSpace: boolean;

    /** 关闭菜单 */
    onClose: () => void;

    /** 新增空间 */
    onAdd: () => void;

    /** 重命名 */
    onRename: (newName: string) => void;

    /** 删除 */
    onDelete: () => void;

    /** 导入单个空间 */
    onImport: (data: SpaceExportData) => Promise<void> | void;

    /** 导入多个空间 */
    onImportMultiple: (data: MultiSpaceExportData) => Promise<void> | void;

    /** 置顶空间 */
    onPin: () => void;

    /** 是否已经在顶部 (禁用置顶) */
    isFirstSpace: boolean;

    /** 当前是否为编辑模式 */
    isEditMode: boolean;

    /** 切换编辑模式 */
    onToggleEditMode: () => void;
}

/**
 * SpaceManageMenu - 空间管理右键菜单
 * 使用共享 Modal 组件，与 AddEditModal/SearchEngineModal 保持一致的定位逻辑
 */
export function SpaceManageMenu({
    isOpen,
    anchorRect,
    currentSpace,
    allSpaces,
    isLastSpace,
    onClose,
    onAdd,
    onRename,
    onDelete,
    onImport,
    onImportMultiple,
    onPin,
    isFirstSpace,
    isEditMode,
    onToggleEditMode,
}: SpaceManageMenuProps) {
    const { t, language } = useLanguage();
    const [isRenaming, setIsRenaming] = useState(false);
    const [renameValue, setRenameValue] = useState('');
    const [isImporting, setIsImporting] = useState(false);
    const menuRef = useRef<HTMLDivElement>(null);
    const inputRef = useRef<HTMLInputElement>(null);
    const fileInputRef = useRef<HTMLInputElement>(null);

    // 重命名模式时自动聚焦
    useEffect(() => {
        if (isRenaming && inputRef.current) {
            inputRef.current.focus();
            inputRef.current.select();
        }
    }, [isRenaming]);

    // 关闭时重置状态
    useEffect(() => {
        if (!isOpen) {
            setIsRenaming(false);
            setRenameValue('');
        }
    }, [isOpen]);

    const handleAddClick = () => {
        onAdd();
        onClose();
    };

    const handleRenameClick = () => {
        setRenameValue(currentSpace.name);
        setIsRenaming(true);
    };

    const handleRenameSubmit = () => {
        const trimmed = renameValue.trim();
        if (trimmed && trimmed !== currentSpace.name) {
            onRename(trimmed);
        }
        setIsRenaming(false);
        onClose();
    };

    const handleRenameKeyDown = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter') {
            handleRenameSubmit();
        } else if (e.key === 'Escape') {
            setIsRenaming(false);
        }
    };

    const handleDeleteClick = () => {
        const message = t.space.deleteConfirm.replace('{name}', currentSpace.name);
        if (!isLastSpace && window.confirm(message)) {
            onDelete();
            onClose();
        }
    };

    const handleExportClick = () => {
        exportSpaceToFile(currentSpace);
        onClose();
    };

    const handleExportAllClick = () => {
        exportAllSpacesToFile(allSpaces);
        onClose();
    };

    const handleImportClick = () => {
        fileInputRef.current?.click();
    };

    const buildImportPreviewMessage = (result: ImportFileResult): string => {
        const preview = buildSpaceImportPreview(result, allSpaces);
        return `${formatSpaceImportPreviewMessage(preview, language)}\n${
            language === 'zh'
                ? '该导入仅新增空间，不会覆盖现有空间设置。'
                : 'This import only adds spaces and does not overwrite existing space settings.'
        }`;
    };

    const executeImportWithPreview = async (input: ImportFileResult) => {
        let result = input;
        if (result.type === 'multi' && result.data.data.spaces.length > 1) {
            const importAll = window.confirm(
                `${buildImportPreviewMessage(result)}\n\n${
                    language === 'zh'
                        ? '确定=全部导入；取消=选择部分导入或放弃'
                        : 'OK = import all; Cancel = select part or abort'
                }`
            );
            if (!importAll) {
                const selectionInput = window.prompt(
                    language === 'zh'
                        ? `输入要导入的序号（从 1 开始，可用逗号和区间，如 1,3-5）\n可选范围：1-${result.data.data.spaces.length}`
                        : `Enter indexes to import (1-based, comma/range allowed, e.g. 1,3-5)\nRange: 1-${result.data.data.spaces.length}`
                );
                if (!selectionInput) {
                    return;
                }
                try {
                    const indexes = parseSpaceImportSelectionInput(
                        selectionInput,
                        result.data.data.spaces.length
                    );
                    if (indexes.length === 0) {
                        return;
                    }
                    result = {
                        type: 'multi',
                        data: pickMultiSpaceImportData(result.data, indexes),
                    };
                    const confirmPartial = window.confirm(
                        `${buildImportPreviewMessage(result)}\n\n${language === 'zh' ? '确认导入选中空间？' : 'Import selected spaces?'}`
                    );
                    if (!confirmPartial) {
                        return;
                    }
                } catch (error) {
                    const message = error instanceof Error ? error.message : 'Invalid selection';
                    window.alert(`${t.space.importFailed}${message}`);
                    return;
                }
            }
        } else {
            const confirmed = window.confirm(
                `${buildImportPreviewMessage(result)}\n\n${language === 'zh' ? '是否继续导入？' : 'Continue import?'}`
            );
            if (!confirmed) {
                return;
            }
        }

        if (isImporting) {
            return;
        }

        setIsImporting(true);
        try {
            if (result.type === 'multi') {
                await onImportMultiple(result.data);
            } else {
                await onImport(result.data);
            }
            onClose();
        } catch (error) {
            const message = error instanceof Error ? error.message : 'Unknown error';
            window.alert(`${t.space.importFailed}${message}`);
        } finally {
            setIsImporting(false);
        }
    };

    const handleCopyShareCode = async () => {
        try {
            const data = await buildSpaceExportData(currentSpace);
            const shareCode = encodeSpaceShareCode({ type: 'single', data });
            await navigator.clipboard.writeText(shareCode);
            window.alert(
                language === 'zh' ? '已复制分享码' : 'Share code copied'
            );
            onClose();
        } catch (error) {
            const message = error instanceof Error ? error.message : 'Unknown error';
            window.alert(`${t.space.importFailed}${message}`);
        }
    };

    const handleImportShareCode = () => {
        const code = window.prompt(
            language === 'zh' ? '粘贴分享码' : 'Paste share code'
        );
        if (!code) return;

        try {
            const result = decodeSpaceShareCode(code);
            void executeImportWithPreview(result);
        } catch (error) {
            const message = error instanceof Error ? error.message : 'Unknown error';
            window.alert(`${t.space.importFailed}${message}`);
        }
    };

    const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        try {
            const result = await parseAndValidateImportFile(file);
            void executeImportWithPreview(result);
        } catch (error) {
            const message = error instanceof Error ? error.message : 'Unknown error';
            window.alert(`${t.space.importFailed}${message}`);
        } finally {
            // 重置文件输入
            if (fileInputRef.current) {
                fileInputRef.current.value = '';
            }
        }
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={undefined} hideHeader anchorRect={anchorRect}>
            <div ref={menuRef} className={styles.menu}>
                {isRenaming ? (
                    <div className={styles.renameContainer}>
                        <div className={styles.renameLabel}>{t.space.renameSpace}</div>
                        <div className={styles.renameInputWrapper}>
                            <input
                                ref={inputRef}
                                type="text"
                                className={styles.renameInput}
                                value={renameValue}
                                onChange={(e) => setRenameValue(e.target.value)}
                                onKeyDown={handleRenameKeyDown}
                                maxLength={10}
                                placeholder={t.space.inputName}
                            />
                            <button
                                className={styles.confirmButton}
                                onClick={handleRenameSubmit}
                                disabled={!renameValue.trim() || renameValue.trim() === currentSpace.name}
                            >
                                {t.space.confirm}
                            </button>
                        </div>
                    </div>
                ) : (
                    <>
                        <div className={styles.label}>{t.space.title}</div>
                        <div className={styles.divider} />
                        <div className={styles.optionsContainer}>
                            <button className={styles.menuItem} onClick={handleAddClick}>
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${plusIcon})`, maskImage: `url(${plusIcon})` }} />
                                <span>{t.space.addSpace}</span>
                            </button>
                            <button className={styles.menuItem} onClick={() => { onToggleEditMode(); onClose(); }}>
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${editIcon})`, maskImage: `url(${editIcon})` }} />
                                <span>{isEditMode ? t.contextMenu.exitEditMode : t.contextMenu.editMode}</span>
                            </button>
                            <button className={styles.menuItem} onClick={handleRenameClick}>
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${writeIcon})`, maskImage: `url(${writeIcon})` }} />
                                <span>{t.space.rename}</span>
                            </button>
                            {/* 置顶 */}
                            <button
                                className={`${styles.menuItem} ${isFirstSpace ? styles.disabled : ''}`}
                                onClick={() => { onPin(); onClose(); }}
                                disabled={isFirstSpace}
                                title={isFirstSpace ? t.space.alreadyAtTop : t.space.pinToTop}
                            >
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${pinIcon})`, maskImage: `url(${pinIcon})` }} />
                                <span>{t.space.pinToTop}</span>
                            </button>
                            <button
                                className={`${styles.menuItem} ${styles.danger} ${isLastSpace ? styles.disabled : ''}`}
                                onClick={handleDeleteClick}
                                disabled={isLastSpace}
                                title={isLastSpace ? 'Reserve at least one space' : t.space.deleteSpace}
                            >
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${trashIcon})`, maskImage: `url(${trashIcon})` }} />
                                <span>{t.space.deleteSpace}</span>
                            </button>
                            {/* 分隔线 */}
                            <div className={styles.divider} />
                            {/* 导入/导出 */}
                            <button
                                className={`${styles.menuItem} ${isImporting ? styles.disabled : ''}`}
                                onClick={handleImportClick}
                                disabled={isImporting}
                            >
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${importIcon})`, maskImage: `url(${importIcon})` }} />
                                <span>{isImporting ? (language === 'zh' ? '导入中...' : 'Importing...') : t.space.importSpace}</span>
                            </button>
                            <button
                                className={`${styles.menuItem} ${isImporting ? styles.disabled : ''}`}
                                onClick={handleImportShareCode}
                                disabled={isImporting}
                            >
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${importIcon})`, maskImage: `url(${importIcon})` }} />
                                <span>{language === 'zh' ? '导入分享码' : 'Import Share Code'}</span>
                            </button>
                            <button className={styles.menuItem} onClick={handleExportClick}>
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${exportIcon})`, maskImage: `url(${exportIcon})` }} />
                                <span>{t.space.exportSpace}</span>
                            </button>
                            <button className={styles.menuItem} onClick={() => { void handleCopyShareCode(); }}>
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${exportIcon})`, maskImage: `url(${exportIcon})` }} />
                                <span>{language === 'zh' ? '复制分享码' : 'Copy Share Code'}</span>
                            </button>
                            <button className={styles.menuItem} onClick={handleExportAllClick}>
                                <span className={styles.icon} style={{ WebkitMaskImage: `url(${exportIcon})`, maskImage: `url(${exportIcon})` }} />
                                <span>{t.space.exportAllSpaces}</span>
                            </button>
                            {/* 隐藏的文件输入框 */}
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".json"
                                style={{ display: 'none' }}
                                onChange={handleFileChange}
                            />
                        </div>
                    </>
                )}
            </div>
        </Modal>
    );
}
